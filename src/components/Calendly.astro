<section class="py-8 px-4 bg-[#87806B]" id="calendly">
	<div class="max-w-[600px] mx-auto">
		<h2
			class="text-[20px] text-center md:text-[32px] leading-[120%] md:leading-[110%] font-bold text-white mb-4"
		>
			Agend√° tu llamada, vamos a resolver tus dudas y consultas, y ver
			juntos si esta Formaci√≥n es para vos.
		</h2>
		<p class="text-center">¬°Aprovecha el precio especial de este mes!</p>
		<iframe
			src="https://calendly.com/dacharryi/consulta-online-formacion-vastu-shastra?hide_gdpr_banner=1&embed_domain=formacionvastushastra.com&embed_type=Inline"
			class="w-full mt-8 min-h-[990px]"
			title="Calendly - Consulta Online Formaci√≥n Vastu Shastra"
			loading="lazy"
			allowtransparency="true"></iframe>
	</div>
	<img
		class="h-[60px] mt-8 md:h-[60px] mx-auto mb-8"
		src="/images/vastu-shastra.webp"
		alt="Ivan Vastu Shastra"
	/>

	<p class="text-white/80 text-center mt-8 text-[14px] md:text-[16px]">
		¬© Formaci√≥n Vastu Shastra 2025. Todos los derechos reservados.
	</p>
	<p class="text-white/60 text-[12px] text-center">
		Este sitio no forma parte de Facebook‚Ñ¢ o Meta Platforms, Inc. La
		informaci√≥n presentada tiene fines educativos y no garantiza resultados
		espec√≠ficos.
		<!-- Al registrarte, acept√°s nuestros
		[T√©rminos y Condiciones] y [Pol√≠tica de Privacidad]. -->
	</p>
</section>

<script is:inline>
	function getCookie(name) {
		const m = document.cookie.match(
			new RegExp("(?:^|; )" + encodeURIComponent(name) + "=([^;]*)"),
		);
		return m ? decodeURIComponent(m[1]) : "";
	}

	// Fallback: si no hay cookie, intentamos inferir desde localStorage con la misma l√≥gica del modal
	function isQualifiedFallbackFromStorage() {
		try {
			const answers = JSON.parse(
				localStorage.getItem("qf_answers") || "{}",
			);
			const ocup = String(answers.ocupacion || "");
			const comp = String(answers.compromiso || "");
			const isTarget = ocup === "arquitecta" || ocup === "disenadora";
			const hasCommitment = comp !== "explorando";
			return isTarget && hasCommitment;
		} catch {
			return false;
		}
	}

	function isQualified() {
		const statusCookie =
			getCookie("qf_status") || localStorage.getItem("qf_status") || "";
		if (statusCookie) return statusCookie === "qualified";
		return isQualifiedFallbackFromStorage();
	}

	// Crea un ID legible si Calendly no trae UUID (m√°x 128 chars)
	function fallbackEventId() {
		return (
			"cal_" +
			Date.now().toString(36) +
			"_" +
			Math.random().toString(36).slice(2, 10)
		);
	}

	// Sanitiza a caracteres v√°lidos para Meta (recomendado)
	function sanitizeId(id) {
		return String(id)
			.replace(/[^a-zA-Z0-9_\-:.]/g, "")
			.slice(0, 128);
	}

	async function sendMetaSchedule(payload) {
		try {
			await fetch("/api/meta-capi", {
				method: "POST",
				headers: { "Content-Type": "application/json" },
				body: JSON.stringify(payload),
				keepalive: true,
			});
		} catch (e) {
			console.error("Error enviando a Meta CAPI:", e);
		}
	}

	console.log("Califica?", isQualified());

	const isQ = isQualified();
	const eventId = fallbackEventId();

	// Datos complementarios
	const email = localStorage.getItem("lead_email") || "";
	const phone = localStorage.getItem("lead_phone") || "";
	const fbp = getCookie("_fbp") || localStorage.getItem("fbp") || "";
	const fbc = getCookie("_fbc") || localStorage.getItem("fbc") || "";

	console.log(
		"Data para Meta: ",
		email,
		" - ",
		phone,
		" - ",
		fbp,
		" - ",
		fbc,
	);

	window.addEventListener("message", async function (e) {
		if (e.origin !== "https://calendly.com") return;
		if (!e?.data || typeof e.data !== "object") return;

		const evt = e.data.event || "";
		if (typeof evt !== "string" || !evt.startsWith("calendly.")) return;

		if (evt === "calendly.event_scheduled") {
			// üëá Enviar SOLO si est√° calificado
			if (isQ) {
				console.log("entra al evento");
				await sendMetaSchedule({
					eventName: "Schedule",
					eventTime: Math.floor(Date.now() / 1000),
					eventSourceUrl: window.location.href,
					actionSource: "website",
					eventId,
					email,
					phone,
					fbp,
					fbc,
				});
			}

			// Marcamos en el Sheet que si agendo
			fetch(
				"https://hook.us2.make.com/5vkgddg57kuana2jmn2evmvhch3ws8p8",
				{
					method: "POST",
					headers: { "Content-Type": "application/json" },
					body: JSON.stringify({
						email,
					}),
				},
			);
 
			const ty_url = "/thankyou?event_id=" + eventId;

			// Redirigir siempre al thankyou (califique o no)
			window.location = ty_url;
		}
	});

	window.addEventListener("load", () => {
		fbq("track", "Lead");
	});
</script>
